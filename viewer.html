<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deutsch mit Rawad · Premium Übung</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
           
            --primary: #8b5cf6;
            --primary-light: #a78bfa;
            --primary-dark: #7c3aed;
            --secondary: #f97316;
            --secondary-light: #fb923c;
            --accent: #06b6d4;
            --accent-light: #22d3ee;
            --success: #10b981;
            --success-light: #34d399;
            --danger: #ef4444;
            --danger-light: #f87171;
            --warning: #f59e0b;
            --gold: #fbbf24;
            
  
            --dark-950: #020617;
            --dark-900: #0f172a;
            --dark-800: #1e293b;
            --dark-700: #334155;
            --gray-400: #94a3b8;
            --gray-300: #cbd5e1;
            --light: #f8fafc;
            
      
            --purple-glow: rgba(139, 92, 246, 0.3);
            --orange-glow: rgba(249, 115, 22, 0.3);
            --blue-glow: rgba(6, 182, 212, 0.3);
            
            --shadow-lg: 0 20px 25px rgba(0,0,0,0.5);
            --shadow-xl: 0 30px 40px rgba(0,0,0,0.6);
            --shadow-2xl: 0 40px 60px rgba(0,0,0,0.7);
            --shadow-glow: 0 0 30px var(--purple-glow);
            --shadow-glow-strong: 0 0 50px var(--purple-glow);
        
            --radius-lg: 24px;
            --radius-xl: 32px;
            --radius-2xl: 40px;
            --radius-full: 9999px;
            
       
            --font-display: 'Outfit', sans-serif;
            --font-body: 'Space Grotesk', sans-serif;
            
            /* animations */
            --transition-normal: 0.3s ease;
            --transition-bounce: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        body {
            font-family: var(--font-body);
            background: var(--dark-950);
            color: var(--gray-300);
            line-height: 1.7;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* خلفية متحركة */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(249, 115, 22, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(6, 182, 212, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: gradientShift 20s ease infinite alternate;
        }

        @keyframes gradientShift {
            0% { opacity: 0.5; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }

        /* ========== شريط التنقل ========== */
        .viewer-nav {
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .back-link {
            color: var(--gray-400);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1rem;
            transition: all var(--transition-normal);
            padding: 12px 24px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .back-link:hover {
            color: var(--primary-light);
            transform: translateX(-5px);
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--primary);
            box-shadow: 0 4px 20px var(--purple-glow);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .logo i {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 20px var(--orange-glow));
            animation: float 3s ease infinite;
        }

        @keyframes float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }

        .logo span {
            background: linear-gradient(135deg, var(--primary-light), var(--secondary-light), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% 200%;
            animation: gradientMove 3s ease infinite;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* ========== Loading Spinner ========== */
        .loading-spinner {
            text-align: center;
            padding: 100px 20px;
        }

        .spinner {
            width: 70px;
            height: 70px;
            border: 4px solid rgba(139, 92, 246, 0.1);
            border-top-color: var(--primary);
            border-right-color: var(--secondary);
            border-bottom-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin: 0 auto 30px;
            box-shadow: 0 0 30px var(--purple-glow);
        }

        @keyframes spin {
            to { transform: rotate(720deg); }
        }

        /* ========== Error & Premium Lock ========== */
        .error-container {
            background: rgba(239, 68, 68, 0.1);
            border-left: 6px solid var(--danger);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            color: var(--danger-light);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 2rem 0;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .premium-lock-box {
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: var(--radius-2xl);
            padding: 4rem 2rem;
            max-width: 500px;
            margin: 3rem auto;
            box-shadow: var(--shadow-2xl), var(--shadow-glow);
        }

        .premium-lock-box i {
            color: var(--gold);
            margin-bottom: 1.5rem;
            filter: drop-shadow(0 0 30px rgba(251, 191, 36, 0.5));
        }

        .premium-lock-box h2 {
            font-family: var(--font-display);
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--light);
        }

        .premium-lock-box p {
            color: var(--gray-400);
            margin-bottom: 1rem;
        }

        .telegram-btn {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, #0088cc, #00a2ff);
            color: white;
            padding: 16px 40px;
            border-radius: var(--radius-full);
            text-decoration: none;
            font-weight: 700;
            font-size: 1.2rem;
            transition: all var(--transition-bounce);
            box-shadow: 0 10px 30px rgba(0, 136, 204, 0.4);
            position: relative;
            overflow: hidden;
            margin: 1.5rem 0;
        }

        .telegram-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        .telegram-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0, 136, 204, 0.6);
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        /* ========== Viewer Content ========== */
        .story-viewer {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-2xl);
            padding: 2.5rem;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .story-viewer::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1), transparent);
            animation: rotate 20s linear infinite;
            pointer-events: none;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        h1 {
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-light), var(--secondary-light), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        /* Summary Box */
        .summary-box {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xl);
            padding: 1.8rem;
            margin: 2rem 0;
            position: relative;
            z-index: 1;
        }

        .summary-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-tab {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 0.7rem 2rem;
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: 1rem;
            color: var(--gray-400);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .summary-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px var(--purple-glow);
        }

        .summary-content {
            font-size: 1.2rem;
            line-height: 1.8;
            color: var(--gray-300);
        }

        /* ========== Score Bar ========== */
        .viewer-score-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
            padding: 25px 30px;
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xl);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .viewer-score-bar::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1), transparent);
            animation: rotate 20s linear infinite;
            pointer-events: none;
        }

        .points-display {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--gold), var(--warning));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            z-index: 1;
        }

        .points-display i {
            font-size: 2rem;
            color: var(--gold);
            -webkit-text-fill-color: var(--gold);
            filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.5));
            animation: float 3s ease infinite;
        }

        .question-counter {
            color: var(--gray-400);
            font-weight: 600;
            font-size: 1.1rem;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-full);
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            z-index: 1;
        }

        .viewer-progress-wrap {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-top: 10px;
            position: relative;
            z-index: 1;
        }

        .viewer-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            border-radius: var(--radius-full);
            transition: width 0.4s ease;
            position: relative;
        }

        .viewer-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        /* ========== Teil Grid المتطور ========== */
        .teil-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin: 40px 0;
            position: relative;
            z-index: 1;
        }

        .teil-card {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xl);
            padding: 25px;
            text-decoration: none;
            color: inherit;
            transition: all var(--transition-bounce);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 300px;
            border-top: 4px solid transparent;
        }

        .teil-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            transform: translateY(-100%);
            transition: transform var(--transition-normal);
        }

        .teil-card:hover::before {
            transform: translateY(0);
        }

        .teil-card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: rgba(139, 92, 246, 0.3);
            box-shadow: var(--shadow-2xl), var(--shadow-glow);
            background: rgba(255, 255, 255, 0.05);
        }

        .teil-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .teil-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 6px 16px;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 700;
            box-shadow: 0 4px 15px var(--purple-glow);
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .task-count {
            background: rgba(255, 255, 255, 0.05);
            padding: 5px 12px;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            color: var(--gray-400);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .teil-title {
            font-family: var(--font-display);
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--light);
            margin-bottom: 8px;
            line-height: 1.4;
            position: relative;
            z-index: 1;
        }

        .teil-subtitle {
            color: var(--gray-400);
            font-size: 0.9rem;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .teil-preview {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-lg);
            border-left: 3px solid transparent;
            transition: all var(--transition-normal);
            position: relative;
            z-index: 1;
        }

        .teil-card:hover .teil-preview {
            border-left-color: var(--primary);
            background: rgba(139, 92, 246, 0.05);
        }

        .teil-preview p {
            color: var(--gray-300);
            font-size: 0.9rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .teil-preview i {
            opacity: 0.5;
        }

        .teil-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            position: relative;
            z-index: 1;
        }

        .difficulty {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-start-teil {
            padding: 8px 20px;
            border-radius: var(--radius-full);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-normal);
            cursor: pointer;
            color: white;
            border: none;
        }

        .btn-start-teil:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }

        .stats-summary {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius-xl);
            border: 1px solid rgba(255, 255, 255, 0.05);
            flex-wrap: wrap;
        }

        .stats-summary > div {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-full);
        }

        /* ========== Stories Grid ========== */
        .stories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
            position: relative;
            z-index: 1;
        }

        .story-card {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xl);
            padding: 30px;
            transition: all var(--transition-bounce);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            min-height: 280px;
        }

        .story-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            transform: translateY(-100%);
            transition: transform var(--transition-normal);
        }

        .story-card:hover::before {
            transform: translateY(0);
        }

        .story-card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: rgba(139, 92, 246, 0.3);
            box-shadow: var(--shadow-2xl), var(--shadow-glow);
        }

        .story-card.premium-card {
            border-color: rgba(251, 191, 36, 0.2);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(251, 191, 36, 0.05));
        }

        .story-card.premium-card:hover {
            border-color: var(--gold);
            box-shadow: 0 0 50px rgba(251, 191, 36, 0.2);
        }

        .story-icon {
            font-size: 3rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            animation: float 3s ease infinite;
        }

        .story-card h3 {
            font-family: var(--font-display);
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--light);
            position: relative;
            z-index: 1;
            line-height: 1.4;
        }

        .story-card p {
            color: var(--gray-400);
            margin-bottom: 25px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 1;
        }

        .story-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            position: relative;
            z-index: 1;
        }

        .story-badge {
            background: rgba(139, 92, 246, 0.15);
            color: var(--primary-light);
            padding: 6px 14px;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 700;
            border: 1px solid rgba(139, 92, 246, 0.3);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .story-badge.premium-badge {
            background: rgba(251, 191, 36, 0.15);
            color: var(--gold);
            border-color: rgba(251, 191, 36, 0.3);
        }

        .btn-start {
            background: transparent;
            color: var(--light);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: var(--radius-full);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all var(--transition-normal);
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .btn-start::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(139, 92, 246, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .btn-start:hover::before {
            width: 150px;
            height: 150px;
        }

        .btn-start:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: translateX(5px);
            box-shadow: 0 4px 20px var(--purple-glow);
        }

        .btn-start.btn-premium:hover {
            background: var(--gold);
            border-color: var(--gold);
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.4);
        }

        .premium-lock {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gold);
            font-size: 1.1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            z-index: 2;
        }

        /* ========== Question Cards ========== */
        .questions-container, .questions-area {
            display: flex;
            flex-direction: column;
            gap: 1.8rem;
            margin-top: 2rem;
            position: relative;
            z-index: 1;
        }

        .question-card, .question-block {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xl);
            padding: 35px;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .question-card::before, .question-block::before {
            content: attr(data-num);
            position: absolute;
            top: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display);
            font-weight: 800;
            font-size: 1.1rem;
            color: white;
            box-shadow: 0 4px 15px var(--purple-glow);
            animation: float 3s ease infinite;
            z-index: 2;
        }

        .question-block::before {
            content: '?';
        }

        .question-text {
            font-size: 1.3rem;
            margin-bottom: 30px;
            color: var(--light);
            line-height: 1.8;
            padding-right: 60px;
            position: relative;
            z-index: 1;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            position: relative;
            z-index: 1;
        }

        .option-r, .option-f, .option-mc, .option-ja-nein, .option-horen4 {
            padding: 18px 25px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            color: var(--light);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all var(--transition-bounce);
            position: relative;
            overflow: hidden;
            text-align: left;
            backdrop-filter: blur(5px);
        }

        .option-r::before, .option-f::before, .option-mc::before, .option-ja-nein::before, .option-horen4::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .option-r:hover::before, .option-f:hover::before, .option-mc:hover::before, .option-ja-nein:hover::before, .option-horen4:hover::before {
            width: 300px;
            height: 300px;
        }

        .option-r {
            border-color: rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.05);
        }

        .option-r:hover:not(:disabled) {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--success);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .option-f {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.05);
        }

        .option-f:hover:not(:disabled) {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        }

        .option-mc {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .option-mc:hover:not(:disabled) {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--primary);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px var(--purple-glow);
        }

        .option-ja-nein {
            border-color: rgba(6, 182, 212, 0.3);
            background: rgba(6, 182, 212, 0.05);
        }

        .option-ja-nein:hover:not(:disabled) {
            background: rgba(6, 182, 212, 0.2);
            border-color: var(--accent);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px var(--blue-glow);
        }

        .option-horen4 {
            border-color: rgba(249, 115, 22, 0.3);
            background: rgba(249, 115, 22, 0.05);
        }

        .option-horen4:hover:not(:disabled) {
            background: rgba(249, 115, 22, 0.2);
            border-color: var(--secondary);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px var(--orange-glow);
        }

        .option-r.correct, .option-f.correct, .option-mc.correct, .option-ja-nein.correct, .option-horen4.correct {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            border-color: var(--success-light);
            color: white;
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }

        .option-r.wrong, .option-f.wrong, .option-mc.wrong, .option-ja-nein.wrong, .option-horen4.wrong {
            background: linear-gradient(135deg, var(--danger), var(--danger-dark));
            border-color: var(--danger-light);
            color: white;
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
        }

        .option-r:disabled, .option-f:disabled, .option-mc:disabled, .option-ja-nein:disabled, .option-horen4:disabled {
            opacity: 0.8;
            cursor: not-allowed;
        }

        /* Feedback */
        .feedback {
            padding: 18px 25px;
            border-radius: var(--radius-lg);
            margin-top: 25px;
            font-weight: 600;
            display: none;
            animation: slideIn 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback.correct {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success-light);
        }

        .feedback.wrong {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger-light);
        }

        /* ========== Zuordnung Section ========== */
        .zuordnung-ads {
            display: flex;
            flex-wrap: wrap;
            gap: 1.2rem;
            margin: 2rem 0;
            position: relative;
            z-index: 1;
        }

        .zuordnung-ad-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px dashed rgba(139, 92, 246, 0.3);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            flex: 1 1 200px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .zuordnung-letter {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 800;
            font-size: 1.3rem;
            box-shadow: 0 4px 15px var(--purple-glow);
        }

        .zuordnung-person-row {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xl);
            padding: 1.8rem;
            margin-bottom: 1.2rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1.5rem;
            transition: all var(--transition-normal);
        }

        .zuordnung-person-row:hover {
            border-color: rgba(139, 92, 246, 0.3);
            box-shadow: var(--shadow-glow);
        }

        .zuordnung-num {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: white;
            box-shadow: 0 4px 15px var(--purple-glow);
        }

        .zuordnung-person-text {
            flex: 3;
            min-width: 250px;
            color: var(--light);
        }

        .zuordnung-select {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(139, 92, 246, 0.3);
            padding: 12px 30px 12px 20px;
            border-radius: var(--radius-full);
            font-weight: 500;
            color: var(--light);
            cursor: pointer;
            font-size: 1rem;
            backdrop-filter: blur(5px);
        }

        .zuordnung-select option {
            background: var(--dark-800);
            color: var(--light);
        }

        .zuordnung-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--purple-glow);
        }

        /* ========== Result Modal ========== */
        .result-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: 20px;
        }

        .result-modal-overlay.show {
            opacity: 1;
        }

        .result-modal {
            background: linear-gradient(135deg, var(--dark-900), var(--dark-950));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: var(--radius-2xl);
            padding: 50px;
            max-width: 550px;
            width: 100%;
            text-align: center;
            position: relative;
            box-shadow: var(--shadow-2xl), var(--shadow-glow-strong);
            transform: scale(0.5) translateY(100px);
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .result-modal-overlay.show .result-modal {
            transform: scale(1) translateY(0);
        }

        .result-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: var(--gray-400);
            font-size: 1.5rem;
            cursor: pointer;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all var(--transition-normal);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .result-modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border-color: var(--danger);
            transform: rotate(90deg);
        }

        .result-modal h2 {
            font-family: var(--font-display);
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-level {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 15px;
            text-shadow: 0 0 30px rgba(251, 191, 36, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .total-points {
            font-family: var(--font-display);
            font-size: 5rem;
            font-weight: 900;
            color: var(--gold);
            margin-bottom: 5px;
            text-shadow: 0 0 40px rgba(251, 191, 36, 0.6);
            line-height: 1;
            animation: float 3s ease infinite;
        }

        .points-label {
            color: var(--gray-400);
            font-size: 1.1rem;
            margin-bottom: 25px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .result-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 25px;
        }

        .result-stats span {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 1.2rem;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-full);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .result-stats span i {
            font-size: 1.3rem;
        }

        .result-stats span:first-child i {
            color: var(--success);
        }

        .result-stats span.wrong i {
            color: var(--danger);
        }

        .status-badge {
            display: inline-block;
            padding: 12px 35px;
            border-radius: var(--radius-full);
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .status-badge.pass {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success-light);
            border: 1px solid rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.3);
        }

        .status-badge.fail {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger-light);
            border: 1px solid rgba(239, 68, 68, 0.3);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.3);
        }

        .subtitle {
            color: var(--gray-400);
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.8;
        }

        .result-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-primary, .btn-secondary {
            padding: 15px 30px;
            border-radius: var(--radius-full);
            text-decoration: none;
            font-weight: 700;
            font-size: 1rem;
            transition: all var(--transition-bounce);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px var(--purple-glow);
        }

        .btn-primary:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px var(--purple-glow);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--primary);
            transform: translateY(-3px) scale(1.05);
        }

        /* ========== Back Link ========== */
        .back-teil-link {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: var(--gray-400);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 1.8rem;
            padding: 10px 20px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all var(--transition-normal);
        }

        .back-teil-link:hover {
            color: var(--primary-light);
            transform: translateX(-5px);
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--primary);
            box-shadow: 0 4px 20px var(--purple-glow);
        }

        .teil-current {
            font-family: var(--font-display);
            font-size: 1.8rem;
            color: var(--primary-light);
            margin: 1rem 0 2rem;
            position: relative;
            z-index: 1;
        }

        .section-card {
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius-2xl);
            padding: 2.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            z-index: 1;
        }

        .section-title {
            font-family: var(--font-display);
            font-size: 2rem;
            margin-bottom: 2rem;
            color: var(--light);
        }

        /* ========== Scrollbar ========== */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-950);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-full);
            border: 3px solid var(--dark-950);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
        }

        /* ========== Responsive ========== */
        @media (max-width: 1024px) {
            .stats-summary {
                flex-direction: column;
            }
            
            .stats-summary > div {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .story-viewer {
                padding: 1.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            .options {
                grid-template-columns: 1fr;
            }

            .question-card, .question-block {
                padding: 25px;
            }

            .question-card::before, .question-block::before {
                top: 15px;
                right: 15px;
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }

            .question-text {
                padding-right: 0;
                font-size: 1.1rem;
            }

            .viewer-score-bar {
                flex-direction: column;
                align-items: stretch;
                padding: 20px;
            }

            .result-modal {
                padding: 30px 20px;
            }

            .total-points {
                font-size: 4rem;
            }

            .result-stats {
                flex-direction: column;
                gap: 10px;
            }

            .teil-grid {
                grid-template-columns: 1fr;
            }

            .stories-grid {
                grid-template-columns: 1fr;
            }

            .zuordnung-person-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .zuordnung-select {
                width: 100%;
            }

            .teil-card {
                min-height: 280px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 16px;
            }

            .logo {
                font-size: 1.4rem;
            }

            .back-link {
                padding: 8px 16px;
                font-size: 0.9rem;
            }

            .question-card, .question-block {
                padding: 20px;
            }

            .result-actions {
                flex-direction: column;
            }

            .btn-primary, .btn-secondary {
                width: 100%;
                justify-content: center;
            }

            .teil-card-header {
                flex-direction: column;
                gap: 10px;
            }

            .task-count {
                align-self: flex-start;
            }
        }
    </style>
</head>

<body>
    <nav class="viewer-nav">
        <div class="container">
            <div class="nav-content">
                <a href="javascript:history.back()" class="back-link">
                    <i class="fas fa-arrow-left"></i> 
                    Zurück
                </a>
                <div class="logo">
                    <i class="fas fa-gem"></i>
                    <span>Deutsch mit Rawad</span>
                </div>
                <div></div>
            </div>
        </div>
    </nav>

    <main class="viewer-main">
        <div class="container">
            <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>Lade Inhalte...</p>
            </div>

            <div id="errorContainer" class="error-container" style="display: none;"></div>

            <div id="contentContainer"></div>
        </div>
    </main>

    <script src="supabase.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const fileKey = urlParams.get('file');
            const storyIndex = urlParams.get('index');
            const sectionIndex = urlParams.get('section');

            const loading = document.getElementById('loadingSpinner');
            const errorDiv = document.getElementById('errorContainer');
            const contentDiv = document.getElementById('contentContainer');

            const POINTS_PER_CORRECT = 10;

            if (!fileKey) {
                showError('Keine Datei angegeben.');
                return;
            }

            const paidFiles = ['lesen2', 'lesen3', 'lesen4', 'lesen5', 'horen1', 'horen2', 'horen3', 'horen4'];
            if (paidFiles.includes(fileKey) && !window.checkSession()) {
                showPremiumLock();
                return;
            }

            loading.style.display = 'block';
            const data = await window.loadQuestionsFile(fileKey);
            loading.style.display = 'none';

            if (!data) {
                showError('Fehler beim Laden der Inhalte.');
                return;
            }

            renderContent(data, fileKey, storyIndex, sectionIndex);

            // دوال مساعدة
            function shuffle(arr) {
                const a = arr.slice();
                for (let i = a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [a[i], a[j]] = [a[j], a[i]];
                }
                return a;
            }

            function calculateTotalTasks(sections) {
                let total = 0;
                sections.forEach(section => {
                    if (section.questions) total += section.questions.length;
                    else if (section.statements) total += section.statements.length;
                    else if (section.persons) {
                        if (section.persons[0] && section.persons[0].statements) {
                            total += section.persons.reduce((acc, p) => acc + (p.statements ? p.statements.length : 0), 0);
                        } else {
                            total += section.persons.length;
                        }
                    }
                });
                return total;
            }

            function getPreviewText(section) {
                if (section.questions && section.questions[0]) {
                    const q = section.questions[0];
                    return (q.question || q.text || 'Klicken Sie zum Starten').substring(0, 60) + '...';
                }
                if (section.statements && section.statements[0]) {
                    const s = section.statements[0];
                    return (s.original || s.text || 'Klicken Sie zum Starten').substring(0, 60) + '...';
                }
                if (section.persons && section.persons[0]) {
                    const p = section.persons[0];
                    if (p.statements && p.statements[0]) {
                        return p.statements[0].original?.substring(0, 60) + '...' || 'Klicken Sie zum Starten';
                    }
                    return `Thema: ${p.theme || 'Übung'}...`;
                }
                return 'Klicken Sie zum Starten';
            }

            function getDifficultyStars(section, color) {
                let difficulty = 1;
                if (section.questions && section.questions.length > 10) difficulty = 3;
                else if (section.questions && section.questions.length > 5) difficulty = 2;
                
                let stars = '';
                for (let i = 0; i < 3; i++) {
                    if (i < difficulty) {
                        stars += `<i class="fas fa-star" style="color: ${color}; font-size: 0.8rem;"></i>`;
                    } else {
                        stars += `<i class="far fa-star" style="color: var(--gray-500); font-size: 0.8rem;"></i>`;
                    }
                }
                return stars;
            }

            function showResultModal(points, correct, wrong, level, isPassed, percentage, fileKey, sectionIdx, type) {
                const modal = document.createElement('div');
                modal.className = 'result-modal-overlay';
                modal.id = 'resultModal';
                const file = fileKey || urlParams.get('file');
                const secIdx = sectionIdx !== undefined ? sectionIdx : (urlParams.get('section') ? parseInt(urlParams.get('section'), 10) : 0);
                const retryUrl = type === 'zuordnung'
                    ? `viewer.html?file=${encodeURIComponent(file)}&section=${secIdx}`
                    : type === 'advanced'
                        ? `viewer.html?file=${encodeURIComponent(file)}&index=${urlParams.get('index') || 0}`
                        : type === 'single'
                            ? `viewer.html?file=lesen1&index=${urlParams.get('index') || 0}`
                            : `viewer.html?file=${encodeURIComponent(file)}&section=${secIdx}`;
                modal.innerHTML = `
                    <div class="result-modal">
                        <button class="result-modal-close" onclick="this.closest('.result-modal-overlay').remove()"><i class="fas fa-times"></i></button>
                        <h2>Ergebnis</h2>
                        <div class="result-level">${level}</div>
                        <div class="total-points">${points}</div>
                        <div class="points-label">Punkte</div>
                        <div class="result-stats">
                            <span><i class="fas fa-check-circle"></i> ${correct} richtig</span>
                            <span class="wrong"><i class="fas fa-times-circle"></i> ${wrong} falsch</span>
                        </div>
                        <span class="status-badge ${isPassed ? 'pass' : 'fail'}">${isPassed ? 'Bestanden ✓' : 'Nicht bestanden'}</span>
                        <p class="subtitle">${percentage === 100 ? 'Perfekt! 🏆' : percentage >= 70 ? 'Gut gemacht! 💪' : isPassed ? 'Geschafft! 🚀' : 'Versuch es nochmal! 💪'}</p>
                        <div class="result-actions">
                            <a href="${retryUrl}" class="btn-secondary"><i class="fas fa-redo"></i> Nochmal</a>
                            <a href="viewer.html?file=${encodeURIComponent(file)}" class="btn-secondary"><i class="fas fa-list"></i> Teilliste</a>
                            <a href="dashboard.html" class="btn-primary"><i class="fas fa-home"></i> Dashboard</a>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => modal.classList.add('show'), 10);
                modal.addEventListener('click', function (e) {
                    if (e.target === modal) modal.remove();
                });
            }

            // ========== دالة renderContent المعدلة ==========
            function renderContent(data, fileKey, storyIndex, sectionIndexParam) {
                // التحقق من أن البيانات مصفوفة (مثل lesen1 أو lesen5)
                if (Array.isArray(data) && data.length > 0) {
                    const first = data[0];
                    const firstQ = first.questions && first.questions[0];
                    
                    // للقصص التي تحتوي على texts (مثل lesen1)
                    if (firstQ && firstQ.texts) {
                        if (storyIndex !== null && storyIndex !== '' && data[parseInt(storyIndex, 10)] !== undefined) {
                            displaySingleStory(data[parseInt(storyIndex, 10)]);
                        } else {
                            displayStoryList(data, fileKey);
                        }
                        return;
                    }
                    
                    // للقصص المتقدمة (مثل lesen5)
                    if (firstQ && (firstQ.correct_answers || firstQ.question)) {
                        if (storyIndex !== null && storyIndex !== '' && data[parseInt(storyIndex, 10)] !== undefined) {
                            displayAdvancedStory(data[parseInt(storyIndex, 10)]);
                        } else {
                            displayAdvancedStoryList(data, fileKey);
                        }
                        return;
                    }
                }
                
                // التحقق من وجود sections
                if (data.sections && data.sections.length > 0) {
                    const secIdx = sectionIndexParam !== null && sectionIndexParam !== '' ? parseInt(sectionIndexParam, 10) : null;
                    
                    // إذا لم يتم تحديد section أو الـ index غير صالح، اعرض قائمة الأقسام
                    const showSectionList = (secIdx === null || isNaN(secIdx) || secIdx < 0 || secIdx >= data.sections.length);
                    
                    if (showSectionList) {
                        // عرض القائمة الرئيسية بشكل أنيق
                        displaySectionList(data, fileKey);
                        return;
                    }
                    
                    // تم تحديد section محدد - اعرض محتواه
                    const selectedSection = data.sections[secIdx];
                    const oneSection = [selectedSection];
                    const dataOne = { name: data.name, sections: oneSection };
                    
                    // التحقق من نوع المحتوى
                    if (selectedSection.ads && selectedSection.solution) {
                        displayLesen3(dataOne, secIdx);
                        return;
                    }
                    
                    if (selectedSection.persons && selectedSection.persons[0] && (selectedSection.persons[0].answer === 'JA' || selectedSection.persons[0].answer === 'NEIN')) {
                        displayLesen4(dataOne, fileKey, secIdx);
                        return;
                    }
                    
                    if (selectedSection.persons && selectedSection.persons[0] && selectedSection.persons[0].person_type && !selectedSection.questions && !selectedSection.statements) {
                        displayHoren4Section(selectedSection, data.name, fileKey, secIdx);
                        return;
                    }
                    
                    // عرض الأقسام العادية
                    displaySections(dataOne, fileKey, secIdx);
                    return;
                }
                
                // التحقق من وجود persons مباشرة
                if (data.persons) {
                    displayPersonsStatements(data);
                    return;
                }
                
                contentDiv.innerHTML = '<p class="error-message">Unbekanntes Datenformat.</p>';
            }

            // ========== دالة displaySectionList المطورة والأنيقة ==========
            function displaySectionList(data, fileKey) {
                const backUrl = 'dashboard.html';
                const isHoren = fileKey && (fileKey.startsWith('horen') || (data.name && data.name.toLowerCase().includes('hörverstehen')));
                
                // تحديد الأيقونة واللون حسب نوع الملف
                let sectionIcon = 'fa-layer-group';
                let sectionColor = 'var(--primary)';
                let sectionTitle = data.name || 'Übungen';
                
                if (fileKey === 'lesen2') {
                    sectionIcon = 'fa-question-circle';
                    sectionColor = 'var(--secondary)';
                    sectionTitle = 'Leseverstehen Teil 2';
                } else if (fileKey === 'lesen3') {
                    sectionIcon = 'fa-puzzle-piece';
                    sectionColor = 'var(--accent)';
                    sectionTitle = 'Zuordnungsübungen - Teil 3';
                } else if (fileKey === 'lesen4') {
                    sectionIcon = 'fa-check-double';
                    sectionColor = 'var(--success)';
                    sectionTitle = 'Ja/Nein-Fragen - Teil 4';
                } else if (fileKey === 'lesen5') {
                    sectionIcon = 'fa-crown';
                    sectionColor = 'var(--gold)';
                    sectionTitle = 'Fortgeschrittene Texte - Teil 5';
                } else if (fileKey?.startsWith('horen')) {
                    sectionIcon = 'fa-headphones';
                    sectionColor = 'var(--secondary)';
                    sectionTitle = 'Hörverstehen';
                }
                
                // بداية الـ HTML
                let html = `
                    <div class="story-viewer">
                        <div class="section-header" style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">
                            <div class="section-icon" style="width: 70px; height: 70px; background: linear-gradient(135deg, ${sectionColor}, ${sectionColor}dd); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas ${sectionIcon}" style="font-size: 2.5rem; color: white;"></i>
                            </div>
                            <div>
                                <h1 style="margin-bottom: 5px;">${sectionTitle}</h1>
                                <p class="teil-list-subtitle" style="color: var(--gray-400); display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <i class="fas fa-hand-point-right" style="color: ${sectionColor};"></i>
                                    <span>Wählen Sie einen Teil zum Üben</span>
                                </p>
                            </div>
                        </div>
                        
                        <div class="stats-summary">
                            <div>
                                <i class="fas fa-book-open" style="color: ${sectionColor};"></i>
                                <span style="color: var(--gray-400);">${data.sections.length} Teile</span>
                            </div>
                            <div>
                                <i class="fas fa-tasks" style="color: ${sectionColor};"></i>
                                <span style="color: var(--gray-400);">${calculateTotalTasks(data.sections)} Aufgaben</span>
                            </div>
                            <div>
                                <i class="fas fa-clock" style="color: ${sectionColor};"></i>
                                <span style="color: var(--gray-400);">${paidFiles.includes(fileKey) ? 'Premium' : 'Kostenlos'}</span>
                            </div>
                        </div>
                        
                        <div class="teil-grid">
                `;
                
                // إنشاء بطاقة لكل Teil
                data.sections.forEach((section, idx) => {
                    let count = 0;
                    let sectionType = '';
                    
                    // حساب عدد المهام حسب نوع القسم
                    if (section.questions) {
                        count = section.questions.length;
                        sectionType = 'Fragen';
                    } else if (section.statements) {
                        count = section.statements.length;
                        sectionType = 'Aussagen';
                    } else if (section.persons) {
                        if (section.persons[0] && section.persons[0].statements) {
                            count = section.persons.reduce((acc, p) => acc + (p.statements ? p.statements.length : 0), 0);
                            sectionType = 'Aussagen';
                        } else {
                            count = section.persons.length;
                            sectionType = 'Personen';
                        }
                    }
                    
                    if (!count) count = '?';
                    
                    // أيقونة مختلفة لكل Teil
                    const teilIcons = ['fa-1', 'fa-2', 'fa-3', 'fa-4', 'fa-5', 'fa-6'];
                    const teilIcon = teilIcons[idx] || 'fa-circle';
                    
                    // لون مختلف لكل Teil
                    const teilColors = ['var(--primary)', 'var(--secondary)', 'var(--accent)', 'var(--success)', 'var(--gold)', 'var(--danger)'];
                    const teilColor = teilColors[idx % teilColors.length];
                    
                    // عنوان Teil
                    let teilTitle = '';
                    if (isHoren) {
                        teilTitle = `Hörverstehen Teil ${idx + 1}`;
                    } else {
                        teilTitle = section.section_title || section.title || `Teil ${idx + 1}`;
                    }
                    
                    // عنوان فرعي
                    const teilSubtitle = section.subtitle || section.theme || section.topic || '';
                    
                    html += `
                        <a href="viewer.html?file=${encodeURIComponent(fileKey)}&section=${idx}" class="teil-card" style="border-top: 4px solid ${teilColor};">
                            <div class="teil-card-header">
                                <span class="teil-badge" style="background: linear-gradient(135deg, ${teilColor}, ${teilColor}dd);">
                                    <i class="fas ${teilIcon}"></i> Teil ${idx + 1}
                                </span>
                                <span class="task-count">
                                    <i class="fas fa-tasks" style="color: ${teilColor};"></i> ${count} ${sectionType}
                                </span>
                            </div>
                            
                            <h3 class="teil-title">${teilTitle}</h3>
                            
                            ${teilSubtitle ? `<p class="teil-subtitle">${teilSubtitle}</p>` : ''}
                            
                            <div class="teil-preview">
                                <p>
                                    <i class="fas fa-quote-right" style="color: ${teilColor}; opacity: 0.5;"></i>
                                    ${getPreviewText(section)}
                                </p>
                            </div>
                            
                            <div class="teil-footer">
                                <span class="difficulty">
                                    ${getDifficultyStars(section, teilColor)}
                                </span>
                                <span class="btn-start-teil" style="background: linear-gradient(135deg, ${teilColor}, ${teilColor}dd);">
                                    <span>Starten</span>
                                    <i class="fas fa-arrow-right"></i>
                                </span>
                            </div>
                        </a>
                    `;
                });
                
                html += `
                        </div>
                        
                        <div class="result-actions" style="margin-top: 40px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <a href="${backUrl}" class="btn-secondary">
                                <i class="fas fa-arrow-left"></i> Zurück zum Dashboard
                            </a>
                            <button class="btn-primary" onclick="window.location.reload()">
                                <i class="fas fa-sync-alt"></i> Aktualisieren
                            </button>
                        </div>
                    </div>
                `;
                
                contentDiv.innerHTML = html;
            }

            // ========== دوال عرض القصص ==========
            function displayStoryList(stories, fileKey) {
                let html = `
                    <div class="story-viewer">
                        <h1>Geschichten</h1>
                        <p class="teil-list-subtitle" style="color: var(--gray-400); margin-bottom: 30px;">
                            <i class="fas fa-book-open" style="color: var(--primary);"></i>
                            Wählen Sie eine Geschichte
                        </p>
                        <div class="stories-grid">
                `;
                
                stories.forEach((story, idx) => {
                    const storyIcon = getStoryIcon(story.title);
                    const questionCount = story.questions ? story.questions.length : 0;
                    
                    html += `
                        <div class="story-card" onclick="window.location.href='viewer.html?file=${fileKey}&index=${idx}'">
                            <div class="story-icon">
                                <i class="fas ${storyIcon}"></i>
                            </div>
                            <h3>${story.title || 'Geschichte ' + (idx + 1)}</h3>
                            <p>
                                <i class="fas fa-question-circle" style="color: var(--primary);"></i>
                                ${questionCount} Fragen
                            </p>
                            <div class="story-footer">
                                <span class="story-badge">
                                    <i class="fas fa-star"></i>
                                    ${fileKey === 'lesen2' ? 'Teil 2' : 'Teil 5'}
                                </span>
                                <button class="btn-start" data-index="${idx}">
                                    <span>Starten</span>
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <div class="result-actions" style="margin-top: 40px;">
                            <a href="dashboard.html" class="btn-secondary">
                                <i class="fas fa-arrow-left"></i> Zurück
                            </a>
                        </div>
                    </div>
                `;
                
                contentDiv.innerHTML = html;
                
                // إضافة event listeners للأزرار
                document.querySelectorAll('.story-card .btn-start').forEach((btn, idx) => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        window.location.href = `viewer.html?file=${fileKey}&index=${idx}`;
                    });
                });
            }

            function displayAdvancedStoryList(stories, fileKey) {
                let html = `
                    <div class="story-viewer">
                        <h1>Fortgeschrittene Übungen</h1>
                        <p class="teil-list-subtitle" style="color: var(--gray-400); margin-bottom: 30px;">
                            <i class="fas fa-crown" style="color: var(--gold);"></i>
                            Wählen Sie eine Übung (Premium)
                        </p>
                        <div class="stories-grid">
                `;
                
                stories.forEach((story, idx) => {
                    const storyIcon = getStoryIcon(story.title);
                    const questionCount = story.questions ? story.questions.length : 0;
                    const isPremium = fileKey !== 'lesen1';
                    
                    html += `
                        <div class="story-card ${isPremium ? 'premium-card' : ''}" 
                             onclick="window.location.href='viewer.html?file=${fileKey}&index=${idx}'">
                            <div class="story-icon">
                                <i class="fas ${storyIcon}"></i>
                            </div>
                            <h3>${story.title || 'Übung ' + (idx + 1)}</h3>
                            <p>
                                <i class="fas fa-question-circle" style="color: var(--primary);"></i>
                                ${questionCount} Aufgaben
                            </p>
                            <div class="story-footer">
                                <span class="story-badge ${isPremium ? 'premium-badge' : ''}">
                                    <i class="fas ${isPremium ? 'fa-crown' : 'fa-star'}"></i>
                                    ${isPremium ? 'Premium' : 'Kostenlos'}
                                </span>
                                <button class="btn-start ${isPremium ? 'btn-premium' : ''}" data-index="${idx}">
                                    <span>Starten</span>
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            ${isPremium ? '<div class="premium-lock"><i class="fas fa-lock"></i></div>' : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <div class="result-actions" style="margin-top: 40px;">
                            <a href="dashboard.html" class="btn-secondary">
                                <i class="fas fa-arrow-left"></i> Zurück
                            </a>
                        </div>
                    </div>
                `;
                
                contentDiv.innerHTML = html;
                
                document.querySelectorAll('.story-card .btn-start').forEach((btn, idx) => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        window.location.href = `viewer.html?file=${fileKey}&index=${idx}`;
                    });
                });
            }

            function getStoryIcon(title) {
                const icons = {
                    'Die Nachbarin': 'fa-user-friends',
                    'Im Wald': 'fa-tree',
                    'Handy verloren': 'fa-mobile-alt',
                    'Das Fahrrad': 'fa-bicycle',
                    'Steffi': 'fa-user-tie',
                    'Japan': 'fa-flag-japan',
                    'Urlaub': 'fa-umbrella-beach',
                    'Arbeit': 'fa-briefcase',
                    'Familie': 'fa-users',
                    'Freunde': 'fa-heart',
                    'Schule': 'fa-graduation-cap',
                    'Universität': 'fa-university',
                    'Reisen': 'fa-plane',
                    'Essen': 'fa-utensils',
                    'Gesundheit': 'fa-heartbeat',
                    'Sport': 'fa-futbol',
                    'Musik': 'fa-music',
                    'Film': 'fa-film',
                    'Entspannt': 'fa-umbrella-beach',
                    'Radfahren': 'fa-bicycle',
                    'Fachkräftemangel': 'fa-briefcase',
                    'Schweiz': 'fa-flag',
                    'Deutschland': 'fa-flag'
                };
                
                for (let key in icons) {
                    if (title?.toLowerCase().includes(key.toLowerCase())) return icons[key];
                }
                return 'fa-book-open';
            }

            function displaySingleStory(story) {
                const totalQuestions = story.questions ? story.questions.length : 0;
                let totalPoints = 0;
                let correctCount = 0;
                let wrongCount = 0;
                const answered = new Set();

                let scoreBarHtml = `
                    <div class="viewer-score-bar" id="viewerScoreBar">
                        <div class="points-display"><i class="fas fa-star"></i> <span id="pointsValue">0</span> Punkte</div>
                        <div class="question-counter" id="questionCounter">Frage 0 von ${totalQuestions}</div>
                        <div class="viewer-progress-wrap" style="width:100%;">
                            <div class="viewer-progress-fill" id="viewerProgressFill" style="width:0%"></div>
                        </div>
                    </div>
                `;

                let html = `
                    <div class="story-viewer" id="storyViewer">
                        <h1>${story.title || 'Geschichte'}</h1>
                        <div class="summary-box">
                            <div class="summary-tabs">
                                <button class="summary-tab active" data-lang="ar">عربي</button>
                                <button class="summary-tab" data-lang="de">Deutsch</button>
                            </div>
                            <div class="summary-content" id="summaryText">${story.summary_ar || ''}</div>
                        </div>
                        ${scoreBarHtml}
                        <div class="questions-container" id="questionsContainer">
                `;

                if (story.questions && Array.isArray(story.questions)) {
                    story.questions.forEach((q, idx) => {
                        const randomText = q.texts && q.texts.length ? q.texts[Math.floor(Math.random() * q.texts.length)] : '?';
                        const labels = [
                            { key: 'R', label: 'Richtig' },
                            { key: 'F', label: 'Falsch' }
                        ];
                        const shuffled = shuffle(labels);
                        const optionsHtml = shuffled.map(o => `
                            <button class="option-${o.key === 'R' ? 'r' : 'f'}" data-answer="${o.key}">${o.label}</button>
                        `).join('');
                        html += `
                            <div class="question-card" data-qid="${idx}" data-num="${idx + 1}">
                                <p class="question-text">${randomText}</p>
                                <div class="options">${optionsHtml}</div>
                                <div class="feedback" style="display:none;"></div>
                            </div>
                        `;
                    });
                }

                html += `</div></div>`;
                contentDiv.innerHTML = html;

                document.querySelectorAll('.summary-tab').forEach(tab => {
                    tab.addEventListener('click', function () {
                        document.querySelectorAll('.summary-tab').forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        const lang = this.dataset.lang;
                        document.getElementById('summaryText').textContent = lang === 'ar' ? story.summary_ar : story.summary_de;
                    });
                });

                function updateScoreBar() {
                    const pts = document.getElementById('pointsValue');
                    const counter = document.getElementById('questionCounter');
                    const fill = document.getElementById('viewerProgressFill');
                    if (pts) pts.textContent = totalPoints;
                    if (counter) counter.textContent = `Frage ${answered.size} von ${totalQuestions}`;
                    if (fill) fill.style.width = totalQuestions ? (answered.size / totalQuestions) * 100 + '%' : '0%';
                }

                function showResult() {
                    const percentage = totalQuestions ? Math.round((correctCount / totalQuestions) * 100) : 0;
                    const isPassed = percentage >= 60;
                    const level = percentage >= 90 ? 'Sehr gut' : percentage >= 70 ? 'Gut' : percentage >= 60 ? 'Bestanden' : 'Nicht bestanden';
                    showResultModal(totalPoints, correctCount, wrongCount, level, isPassed, percentage, 'lesen1', null, 'single');
                }

                document.querySelectorAll('.question-card .option-r, .question-card .option-f').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const card = this.closest('.question-card');
                        const qid = parseInt(card.dataset.qid, 10);
                        if (answered.has(qid)) return;
                        const options = card.querySelectorAll('.option-r, .option-f');
                        const feedback = card.querySelector('.feedback');
                        const selected = this.dataset.answer;
                        const question = story.questions[qid];
                        const correct = question.answer;

                        options.forEach(opt => opt.disabled = true);
                        answered.add(qid);

                        if (selected === correct) {
                            this.classList.add('correct');
                            feedback.innerHTML = '✓ Richtig! +' + POINTS_PER_CORRECT + ' Punkte';
                            feedback.className = 'feedback correct';
                            totalPoints += POINTS_PER_CORRECT;
                            correctCount++;
                        } else {
                            const correctBtn = card.querySelector('[data-answer="' + correct + '"]');
                            if (correctBtn) correctBtn.classList.add('correct');
                            this.classList.add('wrong');
                            feedback.innerHTML = '✗ Falsch. Die richtige Antwort ist: ' + (correct === 'R' ? 'Richtig' : 'Falsch');
                            feedback.className = 'feedback wrong';
                            wrongCount++;
                        }
                        feedback.style.display = 'block';
                        updateScoreBar();

                        if (answered.size === totalQuestions) {
                            setTimeout(showResult, 400);
                        }
                    });
                });

                updateScoreBar();
            }

            function displayAdvancedStory(story) {
                const totalQuestions = story.questions ? story.questions.length : 0;
                let totalPoints = 0;
                let correctCount = 0;
                let wrongCount = 0;
                const answered = new Set();

                let scoreBarHtml = `
                    <div class="viewer-score-bar" id="viewerScoreBar">
                        <div class="points-display"><i class="fas fa-star"></i> <span id="pointsValue">0</span> Punkte</div>
                        <div class="question-counter" id="questionCounter">Frage 0 von ${totalQuestions}</div>
                        <div class="viewer-progress-wrap" style="width:100%;">
                            <div class="viewer-progress-fill" id="viewerProgressFill" style="width:0%"></div>
                        </div>
                    </div>
                `;

                let html = `<div class="story-viewer" id="storyViewer"><h1>${story.title || 'Übung'}</h1>`;
                if (story.summary_ar || story.summary_de) {
                    html += `
                        <div class="summary-box">
                            <div class="summary-tabs">
                                <button class="summary-tab active" data-lang="ar">عربي</button>
                                <button class="summary-tab" data-lang="de">Deutsch</button>
                            </div>
                            <div class="summary-content" id="summaryText">${story.summary_ar || ''}</div>
                        </div>
                    `;
                }
                html += scoreBarHtml + '<div class="questions-container" id="questionsContainer">';

                story.questions.forEach((q, idx) => {
                    const correctAnswers = q.correct_answers || [];
                    const wrongAnswers = q.wrong_answers || [];
                    const oneCorrect = correctAnswers[Math.floor(Math.random() * correctAnswers.length)] || '';
                    const allOptions = shuffle([oneCorrect, ...wrongAnswers].filter(Boolean));
                    const optionsHtml = allOptions.map((opt, i) => {
                        const isCorrect = opt === oneCorrect;
                        const letter = String.fromCharCode(97 + i);
                        return `<button class="option-mc" data-value="${letter}" data-correct="${isCorrect ? '1' : '0'}">${opt}</button>`;
                    }).join('');
                    html += `
                        <div class="question-card" data-qid="${idx}" data-num="${idx + 1}" data-correct-value="${oneCorrect}">
                            <p class="question-text">${q.question || ''}</p>
                            <div class="options mc-options">${optionsHtml}</div>
                            <div class="feedback" style="display:none;"></div>
                        </div>
                    `;
                });

                html += '</div></div>';
                contentDiv.innerHTML = html;

                if (story.summary_ar || story.summary_de) {
                    document.querySelectorAll('.summary-tab').forEach(tab => {
                        tab.addEventListener('click', function () {
                            document.querySelectorAll('.summary-tab').forEach(t => t.classList.remove('active'));
                            this.classList.add('active');
                            document.getElementById('summaryText').textContent = this.dataset.lang === 'ar' ? story.summary_ar : story.summary_de;
                        });
                    });
                }

                function updateScoreBar() {
                    const pts = document.getElementById('pointsValue');
                    const counter = document.getElementById('questionCounter');
                    const fill = document.getElementById('viewerProgressFill');
                    if (pts) pts.textContent = totalPoints;
                    if (counter) counter.textContent = `Frage ${answered.size} von ${totalQuestions}`;
                    if (fill) fill.style.width = totalQuestions ? (answered.size / totalQuestions) * 100 + '%' : '0%';
                }

                function showResult() {
                    const percentage = totalQuestions ? Math.round((correctCount / totalQuestions) * 100) : 0;
                    const isPassed = percentage >= 60;
                    const level = percentage >= 90 ? 'Sehr gut' : percentage >= 70 ? 'Gut' : percentage >= 60 ? 'Bestanden' : 'Nicht bestanden';
                    showResultModal(totalPoints, correctCount, wrongCount, level, isPassed, percentage, urlParams.get('file'), null, 'advanced');
                }

                document.querySelectorAll('.question-card .option-mc').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const card = this.closest('.question-card');
                        const qid = parseInt(card.dataset.qid, 10);
                        if (answered.has(qid)) return;
                        const options = card.querySelectorAll('.option-mc');
                        const feedback = card.querySelector('.feedback');
                        const isCorrect = this.dataset.correct === '1';

                        options.forEach(opt => opt.disabled = true);
                        answered.add(qid);

                        if (isCorrect) {
                            this.classList.add('correct');
                            totalPoints += POINTS_PER_CORRECT;
                            correctCount++;
                            feedback.innerHTML = '✓ Richtig! +' + POINTS_PER_CORRECT + ' Punkte';
                            feedback.className = 'feedback correct';
                        } else {
                            options.forEach(o => { if (o.dataset.correct === '1') o.classList.add('correct'); });
                            this.classList.add('wrong');
                            wrongCount++;
                            feedback.innerHTML = '✗ Falsch. Richtige Antwort: ' + card.dataset.correctValue;
                            feedback.className = 'feedback wrong';
                        }
                        feedback.style.display = 'block';
                        updateScoreBar();
                        if (answered.size === totalQuestions) setTimeout(showResult, 400);
                    });
                });

                updateScoreBar();
            }

            function displayLesen3(data, currentSectionIdx) {
                const secIdx = currentSectionIdx !== undefined ? currentSectionIdx : 0;
                const section = data.sections[0];
                if (!section) {
                    contentDiv.innerHTML = '<p class="error-message">Abschnitt nicht gefunden.</p>';
                    return;
                }
                const solution = section.solution || {};
                const adIds = (section.ads || []).map(a => a.id);
                const file = urlParams.get('file');
                let html = `<div class="story-viewer"><a href="viewer.html?file=${encodeURIComponent(file)}" class="back-teil-link"><i class="fas fa-arrow-left"></i> Zurück zur Teilliste</a><h1>${data.name || 'Zuordnung'}</h1><h2 class="teil-current">Teil ${secIdx + 1}</h2>`;
                html += `<div class="section-card zuordnung-section"><h2 class="section-title">${section.section_title || 'Zuordnung'}</h2>`;
                html += '<p class="zuordnung-instruction">Ordnen Sie jede Person der passenden Anzeige zu (a, b, c, … oder —).</p>';

                html += '<div class="zuordnung-ads">';
                html += '<h3 class="zuordnung-subtitle">Anzeigen</h3>';
                (section.ads || []).forEach(ad => {
                    const text = ad.statements && ad.statements.length ? ad.statements[Math.floor(Math.random() * ad.statements.length)] : '';
                    html += `<div class="zuordnung-ad-card" data-ad-id="${ad.id}"><span class="zuordnung-letter">${ad.id}</span><p>${text}</p></div>`;
                });
                html += '</div>';

                html += '<div class="zuordnung-persons">';
                html += '<h3 class="zuordnung-subtitle">Personen</h3>';
                (section.persons || []).forEach(person => {
                    const text = person.statements && person.statements.length ? person.statements[Math.floor(Math.random() * person.statements.length)] : '';
                    let correctId = solution[String(person.id)];
                    if (correctId === null || correctId === undefined) correctId = 'null';
                    else correctId = String(correctId);
                    html += `<div class="zuordnung-person-row" data-person-id="${person.id}" data-correct="${correctId}">
                        <span class="zuordnung-num">${person.id}</span>
                        <p class="zuordnung-person-text">${text}</p>
                        <div class="zuordnung-select-wrap">
                            <select class="zuordnung-select">
                                <option value="">— wählen —</option>
                                <option value="null">— (keine)</option>
                                ${adIds.map(id => `<option value="${id}">${id}</option>`).join('')}
                            </select>
                        </div>
                        <div class="feedback zuordnung-feedback" style="display:none;"></div>
                    </div>`;
                });
                html += '</div></div></div>';
                contentDiv.innerHTML = html;

                let totalPoints = 0, correctCount = 0, wrongCount = 0, answeredCount = 0;
                const totalRows = contentDiv.querySelectorAll('.zuordnung-person-row').length;
                contentDiv.querySelectorAll('.zuordnung-person-row').forEach(row => {
                    const select = row.querySelector('.zuordnung-select');
                    const feedback = row.querySelector('.zuordnung-feedback');
                    const correct = row.dataset.correct;
                    select.addEventListener('change', function () {
                        if (row.dataset.answered === '1') return;
                        const val = this.value;
                        if (!val) return;
                        row.dataset.answered = '1';
                        select.disabled = true;
                        answeredCount++;
                        const isCorrect = (val === correct);
                        if (isCorrect) {
                            totalPoints += POINTS_PER_CORRECT;
                            correctCount++;
                            feedback.innerHTML = '✓ Richtig! +' + POINTS_PER_CORRECT + ' Punkte';
                            feedback.className = 'feedback zuordnung-feedback correct';
                        } else {
                            wrongCount++;
                            feedback.innerHTML = '✗ Falsch. Richtige Anzeige: ' + (correct || '—');
                            feedback.className = 'feedback zuordnung-feedback wrong';
                        }
                        feedback.style.display = 'block';
                        if (answeredCount === totalRows) showSectionResult(totalPoints, correctCount, wrongCount);
                    });
                });

                function showSectionResult(points, correct, wrong) {
                    const total = correct + wrong;
                    const percentage = total ? Math.round((correct / total) * 100) : 0;
                    const isPassed = percentage >= 60;
                    const level = percentage >= 90 ? 'Sehr gut' : percentage >= 70 ? 'Gut' : percentage >= 60 ? 'Bestanden' : 'Nicht bestanden';
                    const file = urlParams.get('file');
                    const secIdx = currentSectionIdx !== undefined ? currentSectionIdx : 0;
                    showResultModal(points, correct, wrong, level, isPassed, percentage, file, secIdx, 'zuordnung');
                }
            }

            function displayLesen4(data, fileKey, currentSectionIdx) {
                const questionBlocks = [];
                const secIdx = currentSectionIdx !== undefined ? currentSectionIdx : 0;
                const section = data.sections[0];
                if (!section) {
                    contentDiv.innerHTML = '<p class="error-message">Abschnitt nicht gefunden.</p>';
                    return;
                }
                const file = fileKey || urlParams.get('file');
                let html = `<div class="story-viewer"><a href="viewer.html?file=${encodeURIComponent(file)}" class="back-teil-link"><i class="fas fa-arrow-left"></i> Zurück zur Teilliste</a><h1>${data.name || 'Meinungen'}</h1><h2 class="teil-current">Teil ${secIdx + 1}</h2><div class="section-card"><h2 class="section-title">${section.section_title}</h2><div class="questions-area">`;
                (section.persons || []).forEach((person, idx) => {
                    const text = person.statements && person.statements.length ? person.statements[Math.floor(Math.random() * person.statements.length)] : '';
                    const answer = (person.answer || '').toUpperCase();
                    const labels = shuffle([{ val: 'JA', label: 'JA' }, { val: 'NEIN', label: 'NEIN' }]);
                    const optionsHtml = labels.map(o => `<button class="option-ja-nein" data-answer="${o.val}">${o.label}</button>`).join('');
                    html += `<div class="question-block lesen4-block" data-type="janein" data-correct="${answer}" data-id="q${idx}">
                        <p class="question-text">${text}</p>
                        <div class="options options-janein">${optionsHtml}</div>
                        <div class="feedback" style="display:none;"></div>
                    </div>`;
                    questionBlocks.push({ correct: answer });
                });
                html += '</div></div></div>';
                contentDiv.innerHTML = html;
                attachSectionHandlers(questionBlocks, file, secIdx);
            }

            function attachSectionHandlers(questionBlocks, fileKeyParam, secIdxParam) {
                const blocks = document.querySelectorAll('.question-block, .statement-block');
                let answeredCount = 0;
                let totalPoints = 0;
                let correctCount = 0;
                let wrongCount = 0;

                blocks.forEach(block => {
                    const correct = block.dataset.correct;
                    block.querySelectorAll('.option-r, .option-f, .option-mc, .option-ja-nein').forEach(btn => {
                        btn.addEventListener('click', function () {
                            if (block.dataset.answered === '1') return;
                            const options = block.querySelectorAll('.option-r, .option-f, .option-mc, .option-ja-nein');
                            const feedback = block.querySelector('.feedback');
                            const selected = this.dataset.answer || this.dataset.value;

                            options.forEach(opt => opt.disabled = true);
                            block.dataset.answered = '1';
                            answeredCount++;

                            const isCorrect = (correct && selected === correct);
                            if (isCorrect) {
                                this.classList.add('correct');
                                totalPoints += POINTS_PER_CORRECT;
                                correctCount++;
                                feedback.innerHTML = '✓ Richtig! +' + POINTS_PER_CORRECT + ' Punkte';
                                feedback.className = 'feedback correct';
                            } else {
                                if (correct) {
                                    const correctBtn = block.querySelector('[data-answer="' + correct + '"], [data-value="' + correct + '"]');
                                    if (correctBtn) correctBtn.classList.add('correct');
                                }
                                this.classList.add('wrong');
                                wrongCount++;
                                feedback.innerHTML = correct ? ('✗ Falsch. Richtige Antwort: ' + (block.querySelector('[data-value="' + correct + '"]')?.textContent || correct)) : 'Danke für deine Antwort!';
                                feedback.className = 'feedback wrong';
                            }
                            feedback.style.display = 'block';
                            if (answeredCount === blocks.length) {
                                const total = correctCount + wrongCount;
                                const percentage = total ? Math.round((correctCount / total) * 100) : 0;
                                const isPassed = percentage >= 60;
                                const level = percentage >= 90 ? 'Sehr gut' : percentage >= 70 ? 'Gut' : percentage >= 60 ? 'Bestanden' : 'Nicht bestanden';
                                const file = fileKeyParam || urlParams.get('file');
                                const secIdx = secIdxParam !== undefined ? secIdxParam : (urlParams.get('section') ? parseInt(urlParams.get('section'), 10) : 0);
                                showResultModal(totalPoints, correctCount, wrongCount, level, isPassed, percentage, file, secIdx, 'section');
                            }
                        });
                    });
                });
            }

            function displayHoren4Section(section, dataName, fileKey, secIdx) {
                const items = [];
                (section.persons || []).forEach(person => {
                    const personType = person.person_type || 'Person';
                    (person.statements || []).forEach(st => {
                        const text = st.variations && st.variations.length ? st.variations[Math.floor(Math.random() * st.variations.length)] : (st.original || '');
                        items.push({ text, correct: personType });
                    });
                });
                const shuffledItems = shuffle(items);
                const types = ['Mann', 'Frau', 'Moderator'];
                let html = `<div class="story-viewer"><a href="viewer.html?file=${encodeURIComponent(fileKey)}" class="back-teil-link"><i class="fas fa-arrow-left"></i> Zurück zur Teilliste</a><h1>${dataName || 'Hörverstehen'}</h1><h2 class="teil-current">Teil ${secIdx + 1}</h2><p class="horen4-instruction">Wer hat das gesagt? Wählen Sie: Mann, Frau oder Moderator.</p><div class="section-card"><h2 class="section-title">${section.section_title}</h2><div class="questions-area">`;
                shuffledItems.forEach((item, idx) => {
                    const opts = shuffle(types.slice());
                    const optionsHtml = opts.map(t => `<button class="option-horen4" data-answer="${t}">${t}</button>`).join('');
                    html += `<div class="question-block" data-type="horen4" data-correct="${item.correct}" data-id="h4-${idx}">
                        <p class="question-text">${item.text}</p>
                        <div class="options options-horen4">${optionsHtml}</div>
                        <div class="feedback" style="display:none;"></div>
                    </div>`;
                });
                html += '</div></div></div>';
                contentDiv.innerHTML = html;

                let totalPoints = 0, correctCount = 0, wrongCount = 0, answeredCount = 0;
                const blocks = contentDiv.querySelectorAll('.question-block');
                blocks.forEach(block => {
                    block.querySelectorAll('.option-horen4').forEach(btn => {
                        btn.addEventListener('click', function () {
                            if (block.dataset.answered === '1') return;
                            const options = block.querySelectorAll('.option-horen4');
                            const feedback = block.querySelector('.feedback');
                            const correct = block.dataset.correct;
                            const selected = this.dataset.answer;
                            options.forEach(opt => opt.disabled = true);
                            block.dataset.answered = '1';
                            answeredCount++;
                            const isCorrect = selected === correct;
                            if (isCorrect) {
                                this.classList.add('correct');
                                totalPoints += POINTS_PER_CORRECT;
                                correctCount++;
                                feedback.innerHTML = '✓ Richtig! +' + POINTS_PER_CORRECT + ' Punkte';
                                feedback.className = 'feedback correct';
                            } else {
                                const correctBtn = block.querySelector('[data-answer="' + correct + '"]');
                                if (correctBtn) correctBtn.classList.add('correct');
                                this.classList.add('wrong');
                                wrongCount++;
                                feedback.innerHTML = '✗ Falsch. Richtige Antwort: ' + correct;
                                feedback.className = 'feedback wrong';
                            }
                            feedback.style.display = 'block';
                            if (answeredCount === blocks.length) {
                                const total = correctCount + wrongCount;
                                const percentage = total ? Math.round((correctCount / total) * 100) : 0;
                                const isPassed = percentage >= 60;
                                const level = percentage >= 90 ? 'Sehr gut' : percentage >= 70 ? 'Gut' : percentage >= 60 ? 'Bestanden' : 'Nicht bestanden';
                                showResultModal(totalPoints, correctCount, wrongCount, level, isPassed, percentage, fileKey, secIdx, 'horen4');
                            }
                        });
                    });
                });
            }

            function displaySections(data, fileKey, currentSectionIdx) {
                const questionBlocks = [];
                const section = data.sections[0];
                const secIdx = currentSectionIdx !== undefined ? currentSectionIdx : 0;
                const file = fileKey || urlParams.get('file');
                let html = `<div class="story-viewer"><a href="viewer.html?file=${encodeURIComponent(file)}" class="back-teil-link"><i class="fas fa-arrow-left"></i> Zurück zur Teilliste</a><h1>${data.name || 'Übungen'}</h1><h2 class="teil-current">Teil ${secIdx + 1}</h2><div class="section-card"><h2 class="section-title">${section.section_title}</h2>`;
                if (section.summary_ar || section.summary_de) {
                    html += `<div class="summary-box section-summary">
                        <div class="summary-tabs">
                            <button class="summary-tab active" data-lang="ar">عربي</button>
                            <button class="summary-tab" data-lang="de">Deutsch</button>
                        </div>
                        <div class="summary-content" id="sectionSummaryText">${section.summary_ar || section.summary_de}</div>
                    </div>`;
                }
                if (section.hint) html += `<p class="section-hint">${section.hint}</p>`;
                html += '<div class="questions-area">';
                if (section.questions) {
                    section.questions.forEach(q => {
                        html += renderQuestionOrHoren(q, questionBlocks);
                    });
                }
                if (section.statements) {
                    section.statements.forEach(s => {
                        html += renderStatementHoren3(s, questionBlocks);
                    });
                }
                html += '</div></div></div>';
                contentDiv.innerHTML = html;

                if (section.summary_ar || section.summary_de) {
                    document.querySelectorAll('.summary-tab').forEach(tab => {
                        tab.addEventListener('click', function () {
                            document.querySelectorAll('.summary-tab').forEach(t => t.classList.remove('active'));
                            this.classList.add('active');
                            const lang = this.dataset.lang;
                            document.getElementById('sectionSummaryText').textContent = lang === 'ar' ? section.summary_ar : section.summary_de;
                        });
                    });
                }

                attachSectionHandlers(questionBlocks, file, secIdx);
            }

            function renderQuestionOrHoren(q, questionBlocks) {
                if (q.question_type === 'richtig_falsch' || q.question_type === 'multiple_choice') {
                    return renderQuestion(q, questionBlocks);
                }
                if (q.question_text && q.options && q.options.length) {
                    const id = 'q' + Math.random().toString(36).slice(2, 9);
                    questionBlocks.push({ id, correct: q.correct_answer, type: 'mc' });
                    const qText = q.question_variations && q.question_variations.length
                        ? q.question_variations[Math.floor(Math.random() * q.question_variations.length)]
                        : (q.question_text || '');
                    const opts = shuffle(q.options.slice());
                    const optionsHtml = opts.map(opt => `<button class="option-mc" data-value="${opt.id}">${opt.text}</button>`).join('');
                    return `<div class="question-block" data-type="mc" data-id="${id}" data-correct="${q.correct_answer}">
                        <p class="question-text">${qText}</p>
                        <div class="options mc-options">${optionsHtml}</div>
                        <div class="feedback" style="display:none;"></div>
                    </div>`;
                }
                return '';
            }

            function renderStatementHoren3(s, questionBlocks) {
                const id = 's' + Math.random().toString(36).slice(2, 9);
                const answer = s.answer || '';
                questionBlocks.push({ id, correct: answer, type: 'tf' });
                const text = s.variations && s.variations.length
                    ? s.variations[Math.floor(Math.random() * s.variations.length)]
                    : (s.original || '');
                const labels = shuffle([{ val: 'richtig', label: 'Richtig' }, { val: 'falsch', label: 'Falsch' }]);
                const optionsHtml = labels.map(o => `<button class="option-${o.val === 'richtig' ? 'r' : 'f'}" data-answer="${o.val}">${o.label}</button>`).join('');
                return `<div class="question-block" data-type="tf" data-id="${id}" data-correct="${answer}">
                    <p class="question-text">${text}</p>
                    <div class="options">${optionsHtml}</div>
                    <div class="feedback" style="display:none;"></div>
                </div>`;
            }

            function renderQuestion(q, questionBlocks) {
                const id = 'q' + Math.random().toString(36).slice(2, 9);
                questionBlocks.push({ id, correct: q.correct_answer, type: q.question_type });
                if (q.question_type === 'richtig_falsch') {
                    const text = q.statements && q.statements.length ? q.statements[Math.floor(Math.random() * q.statements.length)] : q.question_text || '';
                    const labels = [
                        { val: 'richtig', label: 'Richtig' },
                        { val: 'falsch', label: 'Falsch' }
                    ];
                    const shuffled = shuffle(labels);
                    const optionsHtml = shuffled.map(o => `
                        <button class="option-${o.val === 'richtig' ? 'r' : 'f'}" data-answer="${o.val}">${o.label}</button>
                    `).join('');
                    return `
                        <div class="question-block" data-type="tf" data-id="${id}" data-correct="${q.correct_answer}">
                            <p>${text}</p>
                            <div class="options">${optionsHtml}</div>
                            <div class="feedback" style="display:none;"></div>
                        </div>
                    `;
                }
                if (q.question_type === 'multiple_choice' && q.options) {
                    const opts = shuffle(q.options.slice());
                    const optionsHtml = opts.map(opt => `<button class="option-mc" data-value="${opt.id}">${opt.text}</button>`).join('');
                    return `
                        <div class="question-block" data-type="mc" data-id="${id}" data-correct="${q.correct_answer}">
                            <p>${q.question_text || ''}</p>
                            <div class="options mc-options">${optionsHtml}</div>
                            <div class="feedback" style="display:none;"></div>
                        </div>
                    `;
                }
                return '';
            }

            function displayPersonsStatements(data) {
                let html = `<h1 class="story-viewer">${data.name || 'Aussagen'}</h1>`;
                data.sections.forEach(section => {
                    html += `<div class="section-card"><h2>${section.section_title}</h2>`;
                    (section.persons || []).forEach(person => {
                        html += `<h3 style="font-size:1.1rem;margin:16px 0 8px;color:var(--gray-400);">${person.person_type || ''}</h3>`;
                        (person.statements || []).forEach(s => {
                            html += `
                                <div class="statement-block">
                                    <p>${s.original || (s.statements && s.statements[0]) || ''}</p>
                                    <div class="options">
                                        <button class="option-r" data-answer="richtig">Richtig</button>
                                        <button class="option-f" data-answer="falsch">Falsch</button>
                                    </div>
                                    <div class="feedback" style="display:none;"></div>
                                </div>
                            `;
                        });
                    });
                    html += '</div>';
                });
                contentDiv.innerHTML = html;
                document.querySelectorAll('.statement-block .option-r, .statement-block .option-f').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const block = this.closest('.statement-block');
                        const options = block.querySelectorAll('.option-r, .option-f');
                        const feedback = block.querySelector('.feedback');
                        options.forEach(opt => opt.disabled = true);
                        this.classList.add('selected');
                        feedback.innerHTML = 'Danke für deine Antwort!';
                        feedback.style.display = 'block';
                    });
                });
            }

            function showError(msg) {
                errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${msg}`;
                errorDiv.style.display = 'block';
            }

            function showPremiumLock() {
                contentDiv.innerHTML = `
                    <div class="premium-lock-box">
                        <i class="fas fa-lock fa-4x"></i>
                        <h2>Premium-Inhalt</h2>
                        <p>Dieser Bereich ist nur für Premium-Mitglieder zugänglich.</p>
                        <p>Kontaktiere uns auf Telegram, um deinen Zugang zu erhalten:</p>
                        <a href="https://t.me/mez123794" target="_blank" class="telegram-btn">
                            <i class="fab fa-telegram"></i> @mez123794
                        </a>
                        <p><a href="login.html" style="color: var(--primary);">Bereits Kunde? Hier einloggen</a></p>
                    </div>
                `;
            }
        });
    </script>
</body>

</html>